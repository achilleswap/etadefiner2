<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ETA Goal Definer</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-green-50 font-sans text-gray-800">
  <div class="max-w-xl mx-auto p-6 mt-10 bg-white shadow-lg rounded-2xl">
    <h2 class="text-2xl font-bold text-green-700 mb-4">🚀 ETA Goal Definer</h2>

    <label class="block mb-2 font-medium">Epic(s) Keys</label>
    <div class="flex gap-3 items-center mb-2">
      <input 
        type="text" 
        id="userInput" 
        placeholder="BUILDER-2602, MAT-2453" 
        class="flex-1 px-3 py-2 border border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400"
      />
    </div>
    <p class="text-sm text-gray-500 mb-4">Add the keys of all epics linked to the feature, separated by commas.</p>

    <div class="space-y-2 mb-4">
      <label class="flex items-center gap-2">
        <input type="checkbox" class="check accent-green-600" />
        All tickets have been created and estimated in the attached epic(s)
      </label>
      <label class="flex items-center gap-2">
        <input type="checkbox" class="check accent-green-600" />
        Developments already started
      </label>
      <label class="flex items-center gap-2">
        <input type="checkbox" class="check accent-green-600" />
        If epic(s) contains FE/Mob, FE/Mob already started
      </label>
    </div>

    <button 
      id="estimateBtn" 
      onclick="sendInput()" 
      disabled 
      class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-semibold transition disabled:bg-green-300"
    >
      Estimate
    </button>

    <div id="resultContainer" class="mt-6">
      <h3 class="text-lg font-semibold text-green-700 mb-2">Result :</h3>
      <div id="result" class="bg-green-100 p-4 rounded-lg text-sm"></div>
    </div>
  </div>

  <!-- Simple Spinner -->
  <div id="spinner" class="hidden fixed top-0 left-0 w-full h-full bg-green-50 bg-opacity-50 flex items-center justify-center z-50">
    <div class="animate-spin rounded-full h-16 w-16 border-4 border-green-600 border-t-transparent"></div>
  </div>

  <script>
    const checkboxes = document.querySelectorAll('.check');
    const estimateBtn = document.getElementById('estimateBtn');

    checkboxes.forEach(cb => {
      cb.addEventListener('change', () => {
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        estimateBtn.disabled = !allChecked;
      });
    });

    async function sendInput() {
      const input = document.getElementById('userInput').value.trim();
      const resultDiv = document.getElementById('result');
      const spinner = document.getElementById('spinner');
      
      resultDiv.innerHTML = '';
      spinner.classList.remove('hidden');

      try {
        const response = await fetch('https://n8n.swapcard.com/n8nhook/9478b228-a498-4e95-a755-61193fa7f6f9', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ texte: input })
        });

        if (!response.ok) throw new Error("Erreur HTTP");

        const data = await response.json();

        resultDiv.innerHTML = `
          <p><strong>🧩 Epic:</strong> ${data.epic}</p>
          <p><strong>📋 # Tickets:</strong> ${data.ticketCount}</p>
          <p><strong>✅ Total SP:</strong> ${data.totalSP}</p>
          <p><strong>🧮 Estimated SP:</strong> ${data.estimatedSP}</p>
          <p><strong>📆 DevTime Goal:</strong> ${data.devTimeGoal} days</p>
          ${data.firstInProgressDate ? `<p><strong>🕒 Dev Started:</strong> ${new Date(data.firstInProgressDate).toLocaleDateString()}</p>` : ''}
          ${data.eta ? `<p><strong>🚀 ETA Goal:</strong> ${new Date(data.eta).toLocaleDateString()}</p>` : '<p>🚫 No ticket in "In Progress"</p>'}
        `;
      } catch (err) {
        resultDiv.innerHTML = `<p class="text-red-600">❌ Error while trying to get data.</p>`;
        console.error(err);
      } finally {
        spinner.classList.add('hidden');
      }
    }
  </script>
</body>
</html>
